<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Покупка звёзд</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h3>Купить звёзды</h3>
  <input type="number" id="stars" min="1" value="10">
  <button id="payBtn">Оплатить</button>
  <div id="status"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Токен тестового аккаунта PayMaster
    const PAYMASTER_TOKEN = "1744374395:TEST:1a8282597a855bf711c0"; // вставьте ваш тестовый токен

    const payBtn = document.getElementById("payBtn");
    const starsInput = document.getElementById("stars");
    const status = document.getElementById("status");

    payBtn.addEventListener("click", async () => {
      const stars = parseInt(starsInput.value, 10);
      const amount = stars * 1; // цена 1₽ за звезду

      status.textContent = "Создаём счёт...";

      const payload = {
        externalId: "tg_" + tg.initDataUnsafe.user.id + "_" + Date.now(),
        amount: { value: amount, currency: "RUB" },
        description: `Покупка ${stars} звёзд для TG:${tg.initDataUnsafe.user.id}`
      };

      try {
        const res = await fetch("https://sandbox.paymaster.ru/api/v2/invoices", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${PAYMASTER_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.paymentUrl) {
          status.textContent = "Счёт создан. Переходим к оплате...";
          window.location.href = data.paymentUrl;
        } else {
          status.textContent = "Ошибка создания счёта";
          console.error(data);
        }
      } catch (e) {
        status.textContent = "Ошибка запроса";
        console.error(e);
      }
    });
  </script>
</body>
</html>